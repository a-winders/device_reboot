---
- name: Send auth request to mdm to get all sites
  tags: hawaii
  ansible.builtin.uri:
    url: "https://colonelskitchensink.kfcdev.io/api/dcim/sites/?limit=0"
    method: GET
    validate_certs: false
    return_content: true
    headers:
      Accept-Version: "1.0.0"
      Authorization: !vault |
        $ANSIBLE_VAULT;1.1;AES256
        36643931383635326334353534356236393034643731666664393765336537323563333764386237
        3065613836376537336164303161633939323638623937390a306139396463346264373735373864
        34663136623862666464353535363037346533306563653061623261656236653231343964313835
        6632303639363563310a303763353939393361356232336430613961363931363837373064666539
        36656665616162393866386533313734316230643135323331353430623135363034663530343934
        6164353331643336353031303466373163643737326639383265
  register: mdm_response

- name: Filter items with time zone 'US/Hawaii'
  ansible.builtin.set_fact:
    HI: "{{ mdm_response.json.results | selectattr('time_zone', 'equalto', 'US/Hawaii') | list }}"

# Kiosk
- name: Initialize list to hold kiosk URLs
  ansible.builtin.set_fact:
    kiosk_url_list: []

- name: Append HI stores to mdm URL
  loop: "{{ HI }}"
  ansible.builtin.set_fact:
    kiosk_url_list: "{{ kiosk_url_list + [mdm_kiosk_url + item.name] }}"

- name: Send mdm request to get each site's kiosk info
  loop: "{{ kiosk_url_list }}"
  ansible.builtin.uri:
    url: "{{ item }}"
    method: GET
    status_code:
      - 200
    validate_certs: false
    return_content: true
    headers:
      Accept: application/json
      Authorization: "{{ mdm_token }}"
  register: mdm_kiosk_response

- name: Initialize list to hold all kiosk asset tags
  ansible.builtin.set_fact:
    kiosk_asset_tags: []

- name: Pull asset tags from all results
  ansible.builtin.set_fact:
    kiosk_asset_tags: "{{ kiosk_asset_tags + item.json.results | map(attribute='asset_tag') | list }}"
  loop: "{{ mdm_kiosk_response.results }}"
  when: item.json.results is defined

# POS
- name: Initialize list to hold POS URLs
  ansible.builtin.set_fact:
    pos_url_list: []

- name: Append HI store IDs to mdm URL for POS devices
  loop: "{{ HI }}"
  ansible.builtin.set_fact:
    pos_url_list: "{{ pos_url_list + [mdm_pos_url + item.name] }}"

- name: Send mdm request to get each site's POS info
  loop: "{{ pos_url_list }}"
  ansible.builtin.uri:
    url: "{{ item }}"
    method: GET
    status_code:
      - 200
    validate_certs: false
    return_content: true
    headers:
      Accept: application/json
      Authorization: "{{ mdm_token }}"
  register: mdm_pos_response

- name: Initialize list
  ansible.builtin.set_fact:
    pos_device_ids: []

- name: Pull device ID of each POS from all results
  loop: "{{ mdm_pos_response.results }}"
  ansible.builtin.set_fact:
    pos_device_ids: "{{ pos_device_ids + item.json.results | map(attribute='custom_fields.device_id') | list }}"

# KDS
- name: Initialize list to hold KDS URLs
  ansible.builtin.set_fact:
    kds_url_list: []

- name: Append HI store IDs to mdm URL for KDS devices
  loop: "{{ HI }}"
  ansible.builtin.set_fact:
    kds_url_list: "{{ kds_url_list + [mdm_kds_url + item.name] }}"

- name: Send mdm request to get each site's KDS info
  loop: "{{ kds_url_list }}"
  ansible.builtin.uri:
    url: "{{ item }}"
    method: GET
    status_code:
      - 200
    validate_certs: false
    return_content: true
    headers:
      Accept: application/json
      Authorization: "{{ mdm_token }}"
  register: mdm_kds_response

- name: Initialize list to hold all KDS device IDs
  ansible.builtin.set_fact:
    kds_device_ids: []

- name: Pull device ID of each KDS from all results
  loop: "{{ mdm_kds_response.results }}"
  ansible.builtin.set_fact:
    kds_device_ids: "{{ kds_device_ids + item.json.results | map(attribute='custom_fields.device_id') | list }}"

# ORB
- name: Initialize list to hold ORB URLs
  ansible.builtin.set_fact:
    orb_url_list: []

- name: Append EST store IDs to mdm URL for ORB devices
  loop: "{{ HI }}"
  ansible.builtin.set_fact:
    orb_url_list: "{{ orb_url_list + [mdm_orb_url + item.name] }}"

- name: Send mdm request to get each site's ORB info
  loop: "{{ orb_url_list }}"
  ansible.builtin.uri:
    url: "{{ item }}"
    method: GET
    status_code:
      - 200
    validate_certs: false
    return_content: true
    headers:
      Accept: application/json
      Authorization: "{{ mdm_token }}"
  register: mdm_orb_response

- name: Initialize list to hold all orb device IDs
  ansible.builtin.set_fact:
    orb_device_ids: []

- name: Pull device ID of each orb from all results
  loop: "{{ mdm_orb_response.results }}"
  ansible.builtin.set_fact:
    orb_device_ids: "{{ orb_device_ids + item.json.results | map(attribute='custom_fields.device_id') | list }}"

- name: Print orb_device_ids
  ansible.builtin.debug:
    var: orb_device_ids

- name: Print kds_device_ids
  ansible.builtin.debug:
    var: kds_device_ids

- name: Print all POS device IDs
  ansible.builtin.debug:
    var: pos_device_ids

- name: Print all asset tags
  ansible.builtin.debug:
    var: kiosk_asset_tags

- name: Send auth request to mdm and return token
  ansible.builtin.uri:
    url: "{{ mdm_auth_url }}"
    method: POST
    validate_certs: false
    return_content: true
    headers:
      Accept-Version: "1.0.0"
    body:
      clientSecret: "{{ mdm_clientSecret }}"
    body_format: json
  register: auth_response

- name: Auth token
  ansible.builtin.debug:
    var: auth_response.json

- name: Reboot all POS
  loop: "{{ pos_device_ids }}"
  ansible.builtin.uri:
    url: "{{ mdm_reboot_url }}"
    method: POST
    validate_certs: false
    return_content: true
    headers:
      authPayload: "{{ auth_response.json.data.authPayload }}"
      Accept-Version: "1.0.0"
    body:
      deviceId: "{{ item }}"
    body_format: json
  register: reboot_response
  when: pos_device_ids | length > 0 # ensures the playbook doesn't break if there were no POS found in mdm for this timezone

- name: Print status code and response message for each item
  ansible.builtin.debug:
    msg: "Device ID: {{ item.item }} - Status Code: {{ item.status }} - Response Message: {{ item.json.message }}"
  loop: "{{ reboot_response.results }}"

- name: Reboot all KDS
  loop: "{{ kds_device_ids }}"
  ansible.builtin.uri:
    url: "{{ mdm_reboot_url }}"
    method: POST
    validate_certs: false
    return_content: true
    headers:
      authPayload: "{{ auth_response.json.data.authPayload }}"
      Accept-Version: "1.0.0"
    body:
      deviceId: "{{ item }}"
    body_format: json
  register: reboot_response
  when: kds_device_ids | length > 0 # ensures the playbook doesn't break if there were no KDS found in mdm for this timezone

- name: Print status code and response message for each item
  ansible.builtin.debug:
    msg: "Device ID: {{ item.item }} - Status Code: {{ item.status }} - Response Message: {{ item.json.message }}"
  loop: "{{ reboot_response.results }}"

- name: Reboot all ORB
  loop: "{{ orb_device_ids }}"
  ansible.builtin.uri:
    url: "{{ mdm_reboot_url }}"
    method: POST
    validate_certs: false
    return_content: true
    headers:
      authPayload: "{{ auth_response.json.data.authPayload }}"
      Accept-Version: "1.0.0"
    body:
      deviceId: "{{ item }}"
    body_format: json
  register: reboot_response
  when: orb_device_ids | length > 0 # ensures the playbook doesn't break if there were no ORB found in mdm for this timezone

- name: Print status code and response message for each item
  ansible.builtin.debug:
    msg: "Device ID: {{ item.item }} - Status Code: {{ item.status }} - Response Message: {{ item.json.message }}"
  loop: "{{ reboot_response.results }}"

- name: Reboot all kiosks
  loop: "{{ kiosk_asset_tags }}"
  ansible.builtin.uri:
    url: "{{ mdm_reboot_url }}"
    method: POST
    validate_certs: false
    return_content: true
    headers:
      authPayload: "{{ auth_response.json.data.authPayload }}"
      Accept-Version: "1.0.0"
    body:
      deviceId: "{{ item }}"
    body_format: json
  register: reboot_response

- name: Print status code and response message for each item
  ansible.builtin.debug:
    msg: "Device ID: {{ item.item }} - Status Code: {{ item.status }} - Response Message: {{ item.json.message }}"
  loop: "{{ reboot_response.results }}"
